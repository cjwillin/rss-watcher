name: Secret Scan (one-time)

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks (SARIF)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            --redact
            --report-format sarif
            --report-path gitleaks.sarif

      - name: Run gitleaks (JSON)
        if: always()
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            --redact
            --report-format json
            --report-path gitleaks.json

      - name: Debug (list reports)
        if: always()
        run: |
          ls -la
          test -f gitleaks.sarif && echo "gitleaks.sarif exists" || echo "gitleaks.sarif missing"
          test -f gitleaks.json && echo "gitleaks.json exists" || echo "gitleaks.json missing"

      - name: Upload SARIF to Code Scanning
        if: always() && hashFiles('gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      - name: Upload reports (artifact)
        if: always() && (hashFiles('gitleaks.sarif') != '' || hashFiles('gitleaks.json') != '')
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-reports
          path: |
            gitleaks.sarif
            gitleaks.json

      - name: Job summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Secret Scan (one-time)"
            echo
            echo "This run produced:"
            echo "- \`gitleaks.sarif\` (uploaded to Code Scanning)"
            echo "- \`gitleaks.json\` (downloadable artifact)"
            echo
            if [[ -f gitleaks.json ]]; then
              # gitleaks json is an array; count entries in a robust, jq-free way
              count=$(python - <<'PY'
import json
import sys
try:
  data = json.load(open("gitleaks.json","r",encoding="utf-8"))
  print(len(data) if isinstance(data, list) else 0)
except Exception:
  print(0)
PY
              )
              echo "Findings: **${count}**"
              echo
              echo "Open the **Security -> Code scanning alerts** page for details."
            else
              echo "No \`gitleaks.json\` found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
